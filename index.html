<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.5/camera_utils.js"></script>
<style>
body { font-family: sans-serif; text-align: center; padding: 20px; }
video, canvas { width: 90%; max-width: 400px; margin: 10px auto; border: 1px solid #ccc; display:block; }
input, button { margin: 10px; padding: 8px; width: 80%; max-width: 400px; }
</style>
</head>
<body>

<h2>üìè ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>

<video id="camera" autoplay playsinline></video>
<canvas id="output" width="640" height="480"></canvas>
<br>
<button id="captureBtn">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πâ‡∏≤</button>

<form id="footForm">
<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required><br>
<input type="text" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required><br>
<input type="number" id="length" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πâ‡∏≤ (‡∏ã‡∏°.)" required><br>
<input type="number" id="width" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (‡∏ã‡∏°.)" required><br>
<input type="text" id="shoeSize" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"><br>
<input type="date" id="date" required><br>
<button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</form>

<script>
const videoElement = document.getElementById('camera');
const canvasElement = document.getElementById('output');
const canvasCtx = canvasElement.getContext('2d');

let footLengthCM = 0;
let footWidthCM = 0;

// MediaPipe Pose
const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`});
pose.setOptions({modelComplexity: 1, smoothLandmarks: true});
pose.onResults(onResults);

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Ñ‡∏≠‡∏°
const camera = new Camera(videoElement, {
  onFrame: async () => await pose.send({image: videoElement}),
  width: 640,
  height: 480
});
camera.start();

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (results.poseLandmarks) {
    // ‡πÉ‡∏ä‡πâ keypoints ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    const leftHeel = results.poseLandmarks[29];   // ‡∏™‡πâ‡∏ô‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
    const rightHeel = results.poseLandmarks[30];  // ‡∏™‡πâ‡∏ô‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤
    const leftToe = results.poseLandmarks[31];    // ‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏°‡πà‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
    const rightToe = results.poseLandmarks[32];   // ‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏°‡πà‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πâ‡∏≤ (pixel)
    const footPixelLength = Math.abs(leftHeel.y - leftToe.y) * canvasElement.height;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (pixel)
    const footPixelWidth = Math.abs(leftToe.x - rightToe.x) * canvasElement.width;

    // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á = ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 29.7 cm
    const refPixel = 300; // ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏û
    const refCM = 29.7;

    footLengthCM = (footPixelLength / refPixel) * refCM;
    footWidthCM = (footPixelWidth / refPixel) * refCM;

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó input
    document.getElementById('length').value = footLengthCM.toFixed(1);
    document.getElementById('width').value = footWidthCM.toFixed(1);

    // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î marker
    canvasCtx.fillStyle = "red";
    [leftHeel, rightHeel, leftToe, rightToe].forEach(p => {
      canvasCtx.beginPath();
      canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 5, 0, 2*Math.PI);
      canvasCtx.fill();
    });
  }
  canvasCtx.restore();
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πá‡∏ö Canvas
document.getElementById('captureBtn').onclick = function() {
  const imageDataURL = canvasElement.toDataURL("image/png");
  alert('üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤');
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet
document.getElementById('footForm').addEventListener('submit', e => {
  e.preventDefault();
  fetch("<<‡πÉ‡∏™‡πà URL Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì>>", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      length: document.getElementById('length').value,
      width: document.getElementById('width').value,
      shoeSize: document.getElementById('shoeSize').value,
      date: document.getElementById('date').value
    })
  }).then(() => alert('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'));
});
</script>
</body>
</html>
