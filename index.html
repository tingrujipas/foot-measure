<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.5/camera_utils.js"></script>
<style>
body { font-family: sans-serif; text-align: center; padding: 20px; }
video, canvas, img#snapshotImage { width: 90%; max-width: 400px; margin: 10px auto; border: 1px solid #ccc; display:block; }
input, button { margin: 10px; padding: 8px; width: 80%; max-width: 400px; }
</style>
</head>
<body>

<h2>üìè ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>

<video id="camera" autoplay playsinline></video>
<canvas id="output" width="640" height="480"></canvas>
<button id="captureBtn">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πâ‡∏≤</button>
<img id="snapshotImage">

<form id="footForm">
<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required><br>
<input type="text" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required><br>
<input type="number" id="length" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πâ‡∏≤ (‡∏ã‡∏°.)" required><br>
<input type="number" id="width" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (‡∏ã‡∏°.)" required><br>
<input type="text" id="shoeSize" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"><br>
<input type="date" id="date" required><br>
<button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</form>

<script>
const videoElement = document.getElementById('camera');
const canvasElement = document.getElementById('output');
const canvasCtx = canvasElement.getContext('2d');
const snapshotImage = document.getElementById('snapshotImage');

let footLengthCM = 0;
let footWidthCM = 0;

// MediaPipe Pose
const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`});
pose.setOptions({modelComplexity: 1, smoothLandmarks: true});
pose.onResults(onResults);

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
  .then(stream => videoElement.srcObject = stream)
  .catch(err => {
    // fallback ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => videoElement.srcObject = stream)
      .catch(err2 => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err2));
  });

// ‡πÉ‡∏ä‡πâ MediaPipe Camera
const camera = new Camera(videoElement, {
  onFrame: async () => await pose.send({image: videoElement}),
  width: 640,
  height: 480
});
camera.start();

// ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πâ‡∏≤ + ‡∏ß‡∏≤‡∏î Marker
function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (results.poseLandmarks) {
    const leftHeel = results.poseLandmarks[29];
    const rightHeel = results.poseLandmarks[30];
    const leftToe = results.poseLandmarks[31];
    const rightToe = results.poseLandmarks[32];

    const footPixelLength = Math.abs(leftHeel.y - leftToe.y) * canvasElement.height;
    const footPixelWidth = Math.abs(leftToe.x - rightToe.x) * canvasElement.width;

    // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 29.7 cm
    const refPixel = 300; // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏à‡∏£‡∏¥‡∏á
    const refCM = 29.7;

    footLengthCM = (footPixelLength / refPixel) * refCM;
    footWidthCM = (footPixelWidth / refPixel) * refCM;

    document.getElementById('length').value = footLengthCM.toFixed(1);
    document.getElementById('width').value = footWidthCM.toFixed(1);

    canvasCtx.fillStyle = "red";
    [leftHeel, rightHeel, leftToe, rightToe].forEach(p => {
      canvasCtx.beginPath();
      canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 5, 0, 2*Math.PI);
      canvasCtx.fill();
    });
  }
  canvasCtx.restore();
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û + ‡πÅ‡∏™‡∏î‡∏á + ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
document.getElementById('captureBtn').onclick = function() {
  const canvas = document.getElementById('output');
  const dataURL = canvas.toDataURL("image/png");

  snapshotImage.src = dataURL;

  // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = 'foot_snapshot.png';
  link.click();

  alert('üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏†‡∏≤‡∏û‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet
document.getElementById('footForm').addEventListener('submit', e => {
  e.preventDefault();
  fetch("https://script.google.com/macros/s/AKfycbwhmfKpAbGtGNK_HpV4wCRRM14Z1fnh3b-guDWH_NXjg_Z4qxjwj3CdXieQlTXI8Trk/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      length: document.getElementById('length').value,
      width: document.getElementById('width').value,
      shoeSize: document.getElementById('shoeSize').value,
      date: document.getElementById('date').value
    })
  }).then(() => alert('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'));
});
</script>

</body>
</html>
